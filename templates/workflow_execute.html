<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作流执行</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="/static/css/fontawesome.css" rel="stylesheet">
    <!-- Alpine.js for interactivity -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e293b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    }
                }
            }
        }
    </script>

</head>
<body class="bg-gray-50" x-data="{ sidebarOpen: true }">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <div class="bg-secondary text-white transition-all duration-300 ease-in-out" 
             :class="sidebarOpen ? 'w-64' : 'w-16'">
            <!-- 侧边栏头部 -->
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold" x-show="sidebarOpen" x-transition>ERP系统</h1>
                <button @click="sidebarOpen = !sidebarOpen" 
                        class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <!-- 导航菜单 -->
            <nav class="mt-6">
                <div class="px-3">
                    <a href="/" class="flex items-center px-3 py-3 mb-2 text-sm font-medium rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                        <i class="fas fa-shopping-cart w-5 h-5"></i>
                        <span class="ml-3" x-show="sidebarOpen" x-transition>POD产品选择</span>
                    </a>
                    <a href="/workflow/list" class="flex items-center px-3 py-3 mb-2 text-sm font-medium rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                        <i class="fas fa-list w-5 h-5"></i>
                        <span class="ml-3" x-show="sidebarOpen" x-transition>工作流列表</span>
                    </a>
                    <a href="#" class="flex items-center px-3 py-3 mb-2 text-sm font-medium rounded-lg bg-primary text-white">
                        <i class="fas fa-play w-5 h-5"></i>
                        <span class="ml-3" x-show="sidebarOpen" x-transition>工作流执行</span>
                    </a>
                    <a href="#" class="flex items-center px-3 py-3 mb-2 text-sm font-medium rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                        <i class="fas fa-cog w-5 h-5"></i>
                        <span class="ml-3" x-show="sidebarOpen" x-transition>系统设置</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="flex items-center justify-between px-6 py-4">
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900">工作流执行</h1>
                        <p class="text-sm text-gray-500 mt-1">执行和监控工作流程</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/workflow/list" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            <i class="fas fa-arrow-left mr-2"></i>
                            返回列表
                        </a>
                        <div class="flex items-center space-x-2 text-gray-600">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span class="text-sm font-medium">管理员</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- 面包屑导航 -->
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                <nav class="flex" aria-label="Breadcrumb">
                    <ol class="flex items-center space-x-2">
                        <li>
                            <a href="/" class="text-gray-500 hover:text-gray-700 text-sm">首页</a>
                        </li>
                        <li>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </li>
                        <li>
                            <a href="/workflow/list" class="text-gray-500 hover:text-gray-700 text-sm">工作流列表</a>
                        </li>
                        <li>
                            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                        </li>
                        <li>
                            <span class="text-gray-900 text-sm font-medium">工作流执行</span>
                        </li>
                    </ol>
                </nav>
            </div>

            <!-- 主内容 -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- 提示信息容器 -->
                <div id="alertContainer"></div>

                <!-- 加载状态 -->
                <div class="text-center py-8" id="loading" style="display: none;">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <p class="mt-2 text-gray-600">正在加载工作流...</p>
                </div>

                <!-- 工作流信息卡片 -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6" id="workflowInfo" style="display: none;">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2" id="workflowTitle">工作流名称</h2>
                    <p class="text-gray-600 mb-4" id="workflowDescription">工作流描述</p>
                    <div class="flex items-center space-x-6 text-sm text-gray-500">
                        <span id="nodeCount"><i class="fas fa-sitemap mr-1"></i>0 个节点</span>
                        <span id="createdAt"><i class="fas fa-calendar mr-1"></i>创建时间</span>
                    </div>
                </div>

                <!-- 节点输入表单容器 -->
                <div id="nodeFormsContainer" class="space-y-6">
                    <!-- 节点表单将在这里动态生成 -->
                </div>

                <!-- 执行按钮 -->
                <div class="flex justify-center mt-8">
                    <button id="executeBtn" onclick="executeWorkflow()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-play mr-2"></i>
                        执行工作流
                    </button>
                </div>

                <!-- 执行状态 -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6" id="executionStatus" style="display: none;">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" id="statusIconContainer">
                                <i class="fas fa-spinner fa-spin text-blue-600" id="statusIcon"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-medium text-gray-900" id="statusTitle">正在执行工作流...</h3>
                            <p class="text-gray-600" id="statusMessage">请稍候</p>
                        </div>
                    </div>
                    
                    <!-- 进度条 -->
                    <div class="mb-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- 执行日志 -->
                    <div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto font-mono text-sm" id="logsContainer">
                        <!-- 执行日志将在这里显示 -->
                    </div>
                    
                    <!-- 执行结果 -->
                    <div id="executionResults">
                        <!-- 执行结果将在这里显示 -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 工作流执行 JavaScript -->
    <script>
        let workflowId = null;
        let workflow = null;
        let executionId = null;
        let statusCheckInterval = null;
        let eventSource = null;
        let sessionId = null;
        let currentTaskId = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL获取工作流ID
            const pathParts = window.location.pathname.split('/');
            workflowId = pathParts[pathParts.length - 1];
            
            if (workflowId) {
                loadWorkflow();
            } else {
                showError('未指定工作流ID');
            }
            
            initializeEventListeners();
        });
        
        // 初始化事件监听器
        function initializeEventListeners() {
            // 侧边栏切换
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('-translate-x-full');
                });
            }
        }
        
        // 加载工作流信息
        async function loadWorkflow() {
            try {
                showLoading(true);
                const response = await fetch(`/api/workflows/${workflowId}`);
                const result = await response.json();
                
                if (result.success) {
                    workflow = result.data;
                    renderWorkflowInfo(workflow);
                    renderNodeForms(workflow.nodes || []);
                } else {
                    showError('加载工作流失败: ' + result.error);
                }
            } catch (error) {
                showError('加载工作流失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // 渲染工作流信息
        function renderWorkflowInfo(workflow) {
            document.getElementById('workflowTitle').textContent = workflow.name;
            document.getElementById('workflowDescription').textContent = workflow.description || '暂无描述';
            document.getElementById('nodeCount').innerHTML = `<i class="fas fa-sitemap mr-1"></i>${workflow.nodes?.length || 0} 个节点`;
            document.getElementById('createdAt').innerHTML = `<i class="fas fa-calendar mr-1"></i>${formatDate(workflow.created_at)}`;
            
            document.getElementById('workflowInfo').style.display = 'block';
        }
        
        // 渲染节点输入表单
        function renderNodeForms(nodes) {
            const container = document.getElementById('nodeFormsContainer');
            
            if (nodes.length === 0) {
                container.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg">此工作流没有配置任何节点</div>';
                document.getElementById('executeBtn').disabled = true;
                return;
            }
            
            const html = nodes.map(node => {
                const iconClass = getNodeIconClass(node.type);
                const inputHtml = generateNodeInput(node);
                
                return `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" data-node-id="${node.node_id}">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                    <i class="${iconClass} text-blue-600"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-medium text-gray-900">
                                    ${escapeHtml(node.name)}
                                    ${node.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                </h3>
                                ${node.description ? `<p class="text-gray-600 mt-1">${escapeHtml(node.description)}</p>` : ''}
                            </div>
                        </div>
                        <div class="node-input">
                            ${inputHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // 初始化文件上传
            initializeFileUploads();
        }
        
        // 生成节点输入HTML
        function generateNodeInput(node) {
            const defaultValue = node.default_value || '';
            const required = node.required ? 'required' : '';
            
            switch (node.type) {
                case 'text':
                    return `
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                                id="node_${node.node_id}" rows="3" 
                                placeholder="请输入文本内容..." ${required}>${escapeHtml(defaultValue)}</textarea>
                    `;
                    
                case 'number':
                    return `
                        <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                               id="node_${node.node_id}" placeholder="请输入数字..." value="${escapeHtml(defaultValue)}" ${required}>
                    `;
                    
                case 'image':
                case 'video':
                case 'audio':
                    const acceptTypes = {
                        'image': 'image/*',
                        'video': 'video/*',
                        'audio': 'audio/*'
                    };
                    
                    return `
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-colors" 
                             onclick="document.getElementById('file_${node.node_id}').click()">
                            <div class="text-gray-400 mb-2">
                                <i class="${getNodeIconClass(node.type)} text-3xl"></i>
                            </div>
                            <div class="text-gray-600 mb-1">
                                点击选择${getNodeTypeLabel(node.type)}文件，或拖拽文件到此处
                            </div>
                            <div class="text-sm text-gray-500">支持的格式: ${acceptTypes[node.type]}</div>
                        </div>
                        <input type="file" id="file_${node.node_id}" accept="${acceptTypes[node.type]}" 
                               style="display: none;" ${required}>
                        <div class="mt-3 hidden" id="preview_${node.node_id}">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-900" id="filename_${node.node_id}"></span>
                                    <span class="text-sm text-gray-500" id="filesize_${node.node_id}"></span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                default:
                    return `
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                               id="node_${node.node_id}" placeholder="请输入内容..." value="${escapeHtml(defaultValue)}" ${required}>
                    `;
            }
        }
        
        // 处理文件选择和预览
        function handleFileSelect(nodeId, files) {
            const file = files[0];
            if (!file) return;
            
            const preview = document.getElementById(`preview_${nodeId}`);
            const filename = document.getElementById(`filename_${nodeId}`);
            const filesize = document.getElementById(`filesize_${nodeId}`);
            
            if (filename) {
                filename.textContent = file.name;
            }
            if (filesize) {
                filesize.textContent = formatFileSize(file.size);
            }
            
            if (preview) {
                preview.classList.remove('hidden');
                
                // 根据文件类型创建预览
                const fileType = file.type;
                const fileUrl = URL.createObjectURL(file);
                
                // 清空现有预览内容
                const existingPreview = preview.querySelector('.file-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                if (fileType.startsWith('image/')) {
                    // 图片预览
                    const img = document.createElement('img');
                    img.src = fileUrl;
                    img.className = 'file-preview mt-2 max-w-full max-h-48 object-contain rounded-lg';
                    img.onload = () => URL.revokeObjectURL(fileUrl);
                    preview.appendChild(img);
                } else if (fileType.startsWith('video/')) {
                    // 视频预览
                    const video = document.createElement('video');
                    video.src = fileUrl;
                    video.controls = true;
                    video.className = 'file-preview mt-2 max-w-full max-h-48 rounded-lg';
                    video.onloadeddata = () => URL.revokeObjectURL(fileUrl);
                    preview.appendChild(video);
                } else if (fileType.startsWith('audio/')) {
                    // 音频预览
                    const audio = document.createElement('audio');
                    audio.src = fileUrl;
                    audio.controls = true;
                    audio.className = 'file-preview mt-2 w-full';
                    audio.onloadeddata = () => URL.revokeObjectURL(fileUrl);
                    preview.appendChild(audio);
                }
            }
        }
        
        // 初始化文件上传
        function initializeFileUploads() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                const nodeId = input.id.replace('file_', '');
                
                const uploadArea = input.parentElement.querySelector('.border-dashed');
                const preview = document.getElementById(`preview_${nodeId}`);
                
                input.addEventListener('change', function(e) {
                    handleFileSelect(nodeId, e.target.files);
                });
                
                // 拖拽上传
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        uploadArea.classList.add('border-primary', 'bg-blue-50');
                    });
                    
                    uploadArea.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        uploadArea.classList.remove('border-primary', 'bg-blue-50');
                    });
                    
                    uploadArea.addEventListener('drop', function(e) {
                        e.preventDefault();
                        uploadArea.classList.remove('border-primary', 'bg-blue-50');
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            handleFileSelect(nodeId, files);
                            input.files = files;
                        }
                    });
                }
            });
        }
        

        
        // 根据节点类型获取字段名
        function getFieldNameForNodeType(nodeType) {
            switch (nodeType) {
                case 'image':
                case 'video':
                case 'audio':
                    return 'image'; // RunningHub API统一使用'image'字段名
                case 'text':
                    return 'text';
                default:
                    return 'value';
            }
        }
        
        // 上传文件到服务器
        async function uploadFile(file, nodeId) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('nodeId', nodeId);
            
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`文件上传失败: ${response.statusText}`);
            }
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || '文件上传失败');
            }
            
            // 返回RunningHub的fileName，这是工作流节点需要的路径
            return result.filename;
        }
        
        // 添加日志到执行日志控件
        // 连接到日志流
        function connectToLogStream(sessionId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/logs/${sessionId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const logData = JSON.parse(event.data);
                    if (logData.type === 'log') {
                        addExecutionLog(logData.message, logData.log_type);
                    }
                } catch (e) {
                    console.error('解析日志数据失败:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSE连接错误:', event);
            };
        }
        
        // 添加日志到执行日志控件
          function addExecutionLog(message, type = 'info') {
              const logsContainer = document.getElementById('logsContainer');
              if (!logsContainer) {
                  console.error('日志容器未找到');
                  return;
              }
              
              const timestamp = new Date().toLocaleTimeString();
              const logClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-800';
              
              const logEntry = document.createElement('div');
              logEntry.className = 'mb-2';
              logEntry.innerHTML = `<span class="text-gray-500 text-xs mr-2">[${timestamp}]</span><span class="${logClass}">${message}</span>`;
              
              logsContainer.appendChild(logEntry);
              logsContainer.scrollTop = logsContainer.scrollHeight;
          }
        
        // 执行工作流
        async function executeWorkflow() {
            try {
                // 生成会话ID
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // 建立SSE连接接收实时日志
                connectToLogStream(sessionId);
                
                // 收集所有节点的输入数据
                const inputData = {};
                const fileUploads = [];
                let hasError = false;
                
                // 显示执行状态
                showExecutionStatus('running', '正在准备执行...', '正在处理文件上传');
                addExecutionLog('开始执行工作流', 'info');
                document.getElementById('executeBtn').disabled = true;
                
                // 处理每个节点的数据
                addExecutionLog('开始收集节点数据', 'info');
                for (const node of workflow.nodes || []) {
                    let value = getNodeValue(node);
                    
                    // 检查必填字段
                    if (node.required && (!value || value === '')) {
                        showError(`请填写必填字段: ${node.name}`);
                        addExecutionLog(`验证失败: ${node.name} 为必填字段`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // 处理文件上传
                    if (['image', 'video', 'audio'].includes(node.type)) {
                        const fileInput = document.getElementById(`file_${node.node_id}`);
                        if (fileInput && fileInput.files.length > 0) {
                            try {
                                showExecutionStatus('running', '正在上传文件...', `上传 ${fileInput.files[0].name}`);
                                addExecutionLog(`正在上传文件: ${fileInput.files[0].name}`, 'info');
                                const filename = await uploadFile(fileInput.files[0], node.node_id);
                                value = filename;
                                addExecutionLog(`文件上传成功: ${filename}`, 'success');
                            } catch (error) {
                                showError(`文件上传失败: ${error.message}`);
                                addExecutionLog(`文件上传失败: ${error.message}`, 'error');
                                hasError = true;
                                break;
                            }
                        }
                    }
                    
                    inputData[node.node_id] = value;
                }
                
                addExecutionLog(`收集到 ${workflow.nodes?.length || 0} 个节点的数据`, 'info');
                
                if (hasError) {
                    document.getElementById('executeBtn').disabled = false;
                    return;
                }
                
                // 显示执行状态
                showExecutionStatus('running', '正在创建任务...', '调用RunningHub API');
                addExecutionLog('正在创建RunningHub任务...', 'info');
                
                // 构建RunningHub API的节点信息列表
                const nodeInfoList = [];
                for (const node of workflow.nodes || []) {
                    const value = inputData[node.node_id];
                    if (value) {
                        nodeInfoList.push({
                            nodeId: node.node_id,
                            fieldName: getFieldNameForNodeType(node.type),
                            fieldValue: value
                        });
                    }
                }
                
                addExecutionLog(`构建节点信息列表，包含 ${nodeInfoList.length} 个有效节点`, 'info');
                
                // 调用后端API创建RunningHub任务
                const response = await fetch('/api/runninghub/create-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        workflowId: workflowId,
                        nodeInfoList: nodeInfoList,
                        sessionId: sessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTaskId = result.taskId;
                    showExecutionStatus('running', '任务已创建', `任务ID: ${currentTaskId}`);
                    addExecutionLog(`任务创建成功，任务ID: ${currentTaskId}`, 'success');
                    addExecutionLog('开始监控任务状态...', 'info');
                    startStatusCheck();
                } else {
                    showExecutionStatus('error', '创建任务失败', result.error);
                    addExecutionLog(`任务创建失败: ${result.error}`, 'error');
                    document.getElementById('executeBtn').disabled = false;
                }
            } catch (error) {
                showExecutionStatus('error', '执行失败', error.message);
                addExecutionLog(`执行异常: ${error.message}`, 'error');
                document.getElementById('executeBtn').disabled = false;
            }
        }
        
        // 获取节点值
        function getNodeValue(node) {
            const element = document.getElementById(`node_${node.node_id}`) || document.getElementById(`file_${node.node_id}`);
            
            if (!element) {
                return null;
            }
            
            if (element.type === 'file') {
                const file = element.files[0] || null;
                if (file) {
                    // 对于文件类型，返回文件名而不是文件对象
                    return file.name;
                } else {
                    return null;
                }
            } else {
                const value = element.value;
                return value;
            }
        }
        
        // 开始状态检查 - 每30秒检查一次RunningHub任务状态
        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            // 立即检查一次状态
            checkTaskStatus();
            
            // 每30秒检查一次状态
            statusCheckInterval = setInterval(checkTaskStatus, 30000);
        }
        
        // 检查任务状态
        async function checkTaskStatus() {
            if (!currentTaskId) return;
            
            try {
                const response = await fetch('/api/runninghub/check-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ taskId: currentTaskId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateExecutionStatus(result.status, result.message);
                    addExecutionLog(`任务状态: ${result.status} - ${result.message || ''}`, 'info');
                    
                    // 如果任务完成，获取结果
                    if (result.status === 'SUCCESS') {
                        clearInterval(statusCheckInterval);
                        addExecutionLog('任务执行成功，正在获取结果...', 'success');
                        await getTaskResults();
                        document.getElementById('executeBtn').disabled = false;
                    } else if (result.status === 'FAILED') {
                        clearInterval(statusCheckInterval);
                        showExecutionStatus('error', '任务失败', result.message || '任务执行失败');
                        addExecutionLog(`任务执行失败: ${result.message || '未知错误'}`, 'error');
                        document.getElementById('executeBtn').disabled = false;
                    }
                } else {
                    console.error('状态检查失败:', result.error);
                    addExecutionLog(`状态检查失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('状态检查异常:', error);
            }
        }
        
        // 获取任务结果
        async function getTaskResults() {
            try {
                showExecutionStatus('running', '获取结果中...', '正在下载生成的文件');
                
                const response = await fetch('/api/runninghub/get-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ taskId: currentTaskId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showExecutionStatus('success', '执行完成', `文件已保存到: ${result.outputPath}`);
                    addExecutionLog(`任务完成，输出路径: ${result.outputPath}`, 'success');
                    if (result.files && result.files.length > 0) {
                        addExecutionLog(`生成了 ${result.files.length} 个文件`, 'success');
                    }
                    
                    // 显示结果文件列表
                    displayResults(result.files, result.outputPath);
                } else {
                    showExecutionStatus('error', '获取结果失败', result.error);
                    addExecutionLog(`获取结果失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showExecutionStatus('error', '获取结果异常', error.message);
                addExecutionLog(`获取结果异常: ${error.message}`, 'error');
            }
        }
        
        // 显示结果文件
        function displayResults(files, outputPath) {
            const resultsContainer = document.getElementById('executionResults');
            if (!resultsContainer) return;
            
            let resultHtml = '';
            
            if (outputPath) {
                resultHtml += `
                    <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="text-lg font-semibold text-green-800 mb-2">输出路径:</h4>
                        <p class="text-sm text-green-700">${outputPath}</p>
                    </div>
                `;
            }
            
            if (files && files.length > 0) {
                resultHtml += `
                    <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="text-lg font-semibold text-green-800 mb-2">生成的文件:</h4>
                        <div class="space-y-2">
                            ${files.map(file => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <span class="text-sm">${file.name}</span>
                                    <a href="${file.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                        查看文件
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = resultHtml;
        }
        
        // 更新执行状态
        function updateExecutionStatus(status, message) {
            const statusMap = {
                'PENDING': { type: 'running', title: '任务排队中', desc: '等待执行' },
                'RUNNING': { type: 'running', title: '任务执行中', desc: '正在处理' },
                'SUCCESS': { type: 'success', title: '任务完成', desc: '执行成功' },
                'FAILED': { type: 'error', title: '任务失败', desc: '执行失败' }
            };
            
            const statusInfo = statusMap[status] || { type: 'running', title: '未知状态', desc: message };
            showExecutionStatus(statusInfo.type, statusInfo.title, message || statusInfo.desc);
        }
        
        // 显示执行状态
        function showExecutionStatus(type, title, message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusIconContainer = document.getElementById('statusIconContainer');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const executionStatus = document.getElementById('executionStatus');
            
            // 重置容器类
            statusIconContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center';
            
            // 设置图标和颜色
            let iconClass = '';
            let containerClass = '';
            switch (type) {
                case 'running':
                    iconClass = 'fas fa-spinner fa-spin text-blue-600';
                    containerClass = 'bg-blue-100';
                    break;
                case 'success':
                    iconClass = 'fas fa-check text-green-600';
                    containerClass = 'bg-green-100';
                    break;
                case 'error':
                    iconClass = 'fas fa-times text-red-600';
                    containerClass = 'bg-red-100';
                    break;
            }
            
            statusIconContainer.className += ' ' + containerClass;
            statusIcon.className = iconClass;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            
            executionStatus.style.display = 'block';
        }
        
        // 更新日志
        function updateLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            const html = logs.map(log => `
                <div class="mb-2">
                    <span class="text-gray-500 text-xs mr-2">${formatTime(log.timestamp)}</span>
                    <span class="text-gray-800">${escapeHtml(log.message)}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // 返回上一页
        function goBack() {
            window.history.back();
        }
        
        // 显示/隐藏加载状态
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.style.display = 'block';
            } else {
                loading.style.display = 'none';
            }
        }
        
        // 获取节点图标类
        function getNodeIconClass(type) {
            const icons = {
                'text': 'fas fa-font',
                'image': 'fas fa-image',
                'video': 'fas fa-video',
                'audio': 'fas fa-microphone',
                'number': 'fas fa-hashtag'
            };
            return icons[type] || 'fas fa-question';
        }
        
        // 获取节点类型标签
        function getNodeTypeLabel(type) {
            const labels = {
                'text': '文本',
                'image': '图片',
                'video': '视频',
                'audio': '语音',
                'number': '数字'
            };
            return labels[type] || type;
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '未知';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN');
        }
        
        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString('zh-CN');
        }
        
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 显示错误消息
        function showError(message) {
            showAlert('error', message);
        }
        
        // 显示提示消息
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            let bgColor, textColor, iconClass;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-800';
                    iconClass = 'fas fa-check-circle text-green-400';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-800';
                    iconClass = 'fas fa-exclamation-circle text-red-400';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    textColor = 'text-yellow-800';
                    iconClass = 'fas fa-exclamation-triangle text-yellow-400';
                    break;
                default:
                    bgColor = 'bg-blue-50';
                    textColor = 'text-blue-800';
                    iconClass = 'fas fa-info-circle text-blue-400';
            }
            
            const alertHtml = `
                <div id="${alertId}" class="${bgColor} border border-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-200 ${textColor} px-4 py-3 rounded-lg mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="${iconClass} mr-3"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="document.getElementById('${alertId}').remove()" class="${textColor} hover:${textColor.replace('800', '900')} ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // 3秒后自动隐藏
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 3000);
        }
        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>